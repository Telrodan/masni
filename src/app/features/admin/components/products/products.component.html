<ng-container *ngIf="(isBusy$ | async) === false; else loading">
    <ng-container *ngIf="products$ | async as products; else loading">
        <div class="nyk-products-header">Összes termék</div>

        <p-table
            #table
            styleClass="p-datatable-gridlines"
            [value]="products"
            [globalFilterFields]="['id', 'name', 'category']"
            [paginator]="true"
            [rows]="50"
            [rowsPerPageOptions]="[50, 100, 200]">
            <ng-template pTemplate="caption">
                <div class="nyk-products-actions">
                    <p-button
                        [raised]="true"
                        icon="pi pi-plus"
                        label="Új termék hozzáadása"
                        styleClass="w-full "
                        routerLink="/admin/products/add">
                    </p-button>

                    <span class="p-input-icon-left ml-auto w-full md:w-6">
                        <i class="pi pi-search"></i>

                        <input
                            pInputText
                            pTooltip="Kereshető mezők:
                                Azonosító
                                Név
                                Kategória"
                            tooltipPosition="bottom"
                            class="w-full"
                            type="text"
                            (input)="applyTableGlobalFilter($event, 'contains', table)"
                            placeholder="Keresés" />
                    </span>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th>Kép</th>

                    <th class="nyk-products-id">Azonosító</th>

                    <th pSortableColumn="name">
                        <div class="nyk-products-th-wrapper">
                            Név
                            <p-sortIcon field="name"></p-sortIcon>
                        </div>
                    </th>

                    <th class="nyk-products-category" pSortableColumn="category.name">
                        <div class="nyk-products-th-wrapper">
                            Kategória
                            <p-sortIcon field="category.name"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="stock" class="nyk-products-stock">
                        <div class="nyk-products-th-wrapper">
                            Készlet
                            <p-sortIcon field="stock"></p-sortIcon>
                        </div>
                    </th>

                    <th pSortableColumn="price" class="nyk-products-price">
                        <div class="nyk-products-th-wrapper">
                            Ár
                            <p-sortIcon field="price"></p-sortIcon>
                        </div>
                    </th>

                    <th class="w-3rem"></th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-product let-i="rowIndex">
                <tr>
                    <td class="w-1">
                        <img
                            class="hidden"
                            [src]="product.images[0]"
                            [alt]="'Termék ' + i + ' képe'"
                            (load)="imageLoaded(i)" />

                        <p-image
                            *ngIf="imageLoadedStatus[i]"
                            styleClass="shadow-2"
                            [src]="product.images[0]"
                            [alt]="'Termék ' + i + ' képe'"
                            [preview]="true">
                        </p-image>

                        <p-skeleton
                            *ngIf="!imageLoadedStatus[i]"
                            styleClass="skeleton"></p-skeleton>
                    </td>

                    <td class="nyk-products-id text-primary w-9rem font-italic">
                        {{ product.id }}
                    </td>

                    <td>
                        <div class="flex align-items-center">
                            <p class="text-black-alpha-90 font-medium">
                                {{ product.name }}
                            </p>

                            <i
                                *ngIf="product.isFeatured"
                                class="pi pi-star-fill text-yellow-400 ml-2"
                                pTooltip="Kiemelt termék"
                                tooltipPosition="bottom"></i>

                            <i
                                *ngIf="product.isCustom"
                                class="pi pi-palette text-green-400 ml-2"
                                pTooltip="Egyedi termék"
                                tooltipPosition="bottom"></i>
                        </div>
                    </td>

                    <td class="nyk-products-category w-10rem text-center">
                        <p-badge
                            styleClass="shadow-2"
                            [value]="product.category.name"
                            severity="success">
                        </p-badge>
                    </td>

                    <td class="nyk-products-stock w-9rem text-center">
                        <p-badge
                            styleClass="shadow-2"
                            [value]="
                                product.stock > 0
                                    ? 'Készleten: ' + product.stock
                                    : 'Nincs készleten'
                            "
                            [severity]="product.stock > 0 ? 'success' : 'danger'">
                        </p-badge>
                    </td>

                    <td class="nyk-products-price text-black-alpha-90 w-7rem text-center">
                        <span
                            [ngClass]="{
                                'line-through': product.discountedPrice > 0,
                                'text-red-500': product.discountedPrice > 0
                            }">
                            {{ product.price }} Ft
                        </span>

                        <br />

                        <span *ngIf="product.discountedPrice > 0">
                            {{ product.discountedPrice }} Ft
                        </span>
                    </td>

                    <td>
                        <div class="flex flex-column">
                            <p-button
                                [raised]="true"
                                icon="pi pi-cog"
                                severity="info"
                                styleClass="mb-2"
                                [routerLink]="['/admin/products/edit', product.id]"
                                pTooltip="Termék módosítása"
                                tooltipPosition="left">
                            </p-button>

                            <p-button
                                [raised]="true"
                                icon="pi pi-times"
                                severity="danger"
                                pTooltip="Termék törlése"
                                tooltipPosition="left"
                                (click)="onDeleteProduct(product)">
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7" class="text-center text-800 text-4xl h-20rem">
                        Nem található termék
                        <p-button
                            [raised]="true"
                            icon="pi pi-plus"
                            label="Új termék hozzáadása"
                            styleClass="block mx-auto mt-2"
                            routerLink="/admin/products/add">
                        </p-button>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </ng-container>
</ng-container>

<ng-template #loading>
    <nyk-spinner></nyk-spinner>
</ng-template>
