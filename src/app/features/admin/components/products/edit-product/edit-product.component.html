<ng-container *ngIf="!isLoading; else loading">
  <ng-container *ngIf="product$ | async as product; else loading">
    <div class="font-medium text-2xl text-900">Termék módosítása</div>

    <p-divider styleClass="mb-5"></p-divider>

    <form class="flex-auto p-fluid" [formGroup]="editProductForm">
      <div class="form-group">
        <label for="name" class="block font-medium text-900 mb-2 text-lg">
          Termék neve
        </label>

        <input id="name" type="text" formControlName="name" pInputText />
      </div>

      <div class="form-group" *ngIf="categories$ | async as categories">
        <label for="categoryId" class="block font-medium text-900 mb-2 text-lg">
          Termék kategória
        </label>

        <p-dropdown
          id="categoryId"
          formControlName="categoryId"
          [options]="categories"
          placeholder="Válassz egy kategóriát"
          optionValue="id"
          optionLabel="name">
        </p-dropdown>
      </div>

      <div class="form-group">
        <label
          for="shortDescription"
          class="block font-medium text-900 mb-2 text-lg">
          Termék rövid leírása
        </label>

        <input
          id="shortDescription"
          type="text"
          formControlName="shortDescription"
          pInputText />
      </div>

      <div class="form-group">
        <label
          for="description"
          class="block font-medium text-900 mb-2 text-lg">
          Termék leírása
        </label>

        <p-editor
          formControlName="description"
          [style]="{ height: '320px' }"></p-editor>
      </div>

      <div class="form-group">
        <label for="price" class="block font-medium text-900 mb-2 text-lg">
          Termék ára
        </label>

        <input id="price" formControlName="price" type="text" pInputText />
      </div>

      <div class="form-group">
        <label
          for="discountedPrice"
          class="block font-medium text-900 mb-2 text-lg">
          Termék akciós ára
        </label>

        <input
          id="discountedPrice"
          formControlName="discountedPrice"
          type="text"
          pInputText />
      </div>

      <div class="form-group">
        <label for="stock" class="block font-medium text-900 mb-2 text-lg">
          Készleten
        </label>

        <input id="stock" formControlName="stock" type="text" pInputText />
      </div>

      <div class="form-group">
        <label
          for="selectedQuestion"
          class="block font-medium text-900 mb-2 text-lg">
          Kérdések
        </label>

        <div class="questions-wrapper">
          <p-dropdown
            id="selectedQuestion"
            formControlName="selectedQuestion"
            [options]="questions"
            placeholder="Válassz egy kérdést"
            optionValue="id"
            optionLabel="name"
            styleClass="mr-2">
          </p-dropdown>

          <p-button
            icon="pi pi-plus"
            styleClass="p-button-success"
            pTooltip="Kérdés hozzáadása"
            tooltipPosition="bottom"
            (click)="addQuestion()"></p-button>
        </div>
      </div>

      <ng-container *ngIf="selectedQuestions.length">
        <div class="form-group w-6">
          <h3 class="font-medium text-blue-500 mb-1">Választott kérdések</h3>

          <div
            class="option-wrapper mb-2"
            *ngFor="let question of selectedQuestions; let i = index">
            <p class="block font-medium text-800 mb-1">
              {{ i + 1 }}. {{ question.name }}
            </p>

            <p-button
              icon="pi pi-times"
              styleClass="p-button-danger"
              (click)="deleteQuestion(question.id, i)">
            </p-button>
          </div>
        </div>
      </ng-container>

      <div class="form-group">
        <label class="block font-medium text-900 mb-2 text-lg">
          Egyedi termék
        </label>

        <p-inputSwitch formControlName="isCustom"></p-inputSwitch>
      </div>

      <ng-container *ngIf="editProductForm.value.isCustom">
        <div
          *ngIf="inspirationCategories$ | async as inspirationCategories"
          class="form-group">
          <label
            for="inspirationCategoryId"
            class="block font-medium text-900 mb-2 text-lg">
            Inspiráció kategória
          </label>

          <p-dropdown
            id="inspirationCategoryId"
            formControlName="inspirationCategoryId"
            [options]="inspirationCategories"
            placeholder="Válassz egy kategóriát"
            optionValue="id"
            optionLabel="name"
            styleClass="w-full">
          </p-dropdown>
        </div>
      </ng-container>

      <div class="form-group">
        <label class="block font-medium text-900 mb-2 text-lg">Babaruha</label>

        <p-inputSwitch formControlName="isDollDress"></p-inputSwitch>
      </div>

      <div class="form-group">
        <label class="block font-medium text-900 mb-2 text-lg">
          Öltöztethető
        </label>

        <p-inputSwitch formControlName="isDressable"></p-inputSwitch>
      </div>

      <div class="form-group">
        <label class="block font-medium text-900 mb-2 text-lg">
          Kiemelt termék
        </label>

        <p-inputSwitch formControlName="isFeatured"></p-inputSwitch>
      </div>

      <div class="form-group">
        <label
          for="isNameEmbroideryAvailable"
          class="block font-medium text-900 mb-2 text-lg">
          Név hímzés elérhető
        </label>

        <p-inputSwitch
          formControlName="isNameEmbroideryAvailable"></p-inputSwitch>
      </div>

      <div class="form-group">
        <label for="images" class="block font-medium text-900 mb-2 text-lg">
          Termék képek (az első kép lesz mindig a nagy kép)
        </label>

        <p-button
          *ngIf="imagesPreview.length === 0; else clearImagesButton"
          icon="pi pi-image"
          styleClass="p-button p-button-secondary"
          (click)="imagesPicker.click()">
        </p-button>

        <ng-template #clearImagesButton>
          <button
            pButton
            pRipple
            pTooltip="Kép törlése"
            tooltipPosition="bottom"
            (click)="onImageClear(imagesPicker)"
            type="button"
            icon="pi pi-times"
            class="p-button p-button-danger p-button mb-2"></button>
        </ng-template>

        <input
          id="imagesPicker"
          multiple
          type="file"
          class="hidden"
          #imagesPicker
          (change)="onImagePicked($event)" />

        <div
          cdkDropList
          cdkDropListOrientation="horizontal"
          class="nyk-edit-product-images-container"
          (cdkDropListDropped)="drop($event)">
          <div
            *ngFor="let image of imagesPreview"
            class="nyk-edit-product-image"
            cdkDrag>
            <img [src]="image" />
            <img *cdkDragPreview [src]="image" />
          </div>
        </div>
      </div>
    </form>

    <p-button
      label="Módosítás"
      styleClass="p-button w-full mb-3"
      [disabled]="!editProductForm.valid && editProductForm.dirty"
      (click)="onEditProduct()">
    </p-button>

    <div class="font-medium text-2xl text-900">Kategória előzmények</div>
    <p-divider styleClass="mb-5"></p-divider>

    <span class="text-blue-500">
      Hozzáadva: {{ product.createdAt | date : "yyy, MMM dd '-' hh:mm a" }}
    </span>

    <span class="text-green-500 block mb-4">
      Utoljára módosítva:
      {{ product.updatedAt | date : "yyy, MMM dd '-' hh:mm a" }}
    </span>

    <p-table [value]="product.logs">
      <ng-template pTemplate="header">
        <tr>
          <th>Modul</th>
          <th>Dátum</th>
          <th>Üzenet</th>
          <th>Felhasználó</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-log>
        <tr>
          <td>{{ log.meta.module }}</td>
          <td>{{ log.timestamp | date : "yyy, MMM dd '-' hh:mm a" }}</td>
          <td>{{ log.message }}</td>
          <td>{{ log.meta.user }}</td>
        </tr>
      </ng-template>
    </p-table>
  </ng-container>
</ng-container>

<ng-template #loading>
  <nyk-spinner></nyk-spinner>
</ng-template>
