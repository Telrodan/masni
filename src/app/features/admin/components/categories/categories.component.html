<ng-container *ngIf="(isBusy$ | async) === false; else loading">
    <ng-container *ngIf="categories$ | async as categories; else loading">
        <div class="nyk-categories-header">Összes kategória</div>

        <p-table
            #table
            styleClass="p-datatable-gridlines"
            [value]="categories"
            [globalFilterFields]="['id', 'name']"
            [paginator]="true"
            [rows]="50"
            [rowsPerPageOptions]="[50, 100, 200]">
            <ng-template pTemplate="caption">
                <div class="nyk-categories-actions">
                    <p-button
                        icon="pi pi-plus"
                        label="Új kategória hozzáadása"
                        styleClass="w-full"
                        [raised]="true"
                        routerLink="/admin/categories/add">
                    </p-button>

                    <span class="p-input-icon-left ml-auto w-full md:w-6">
                        <i class="pi pi-search"></i>

                        <input
                            pInputText
                            pTooltip="Kereshető mezők:
                            Azonosító
                            Név"
                            tooltipPosition="bottom"
                            class="w-full"
                            type="text"
                            (input)="applyTableGlobalFilter($event, 'contains', table)"
                            placeholder="Keresés" />
                    </span>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th>Kép</th>

                    <th class="nyk-categories-id">Azonosító</th>

                    <th pSortableColumn="name">
                        Név
                        <p-sortIcon field="name"></p-sortIcon>
                    </th>

                    <th class="nyk-categories-item-type" pSortableColumn="type">
                        Tétel típus
                        <p-sortIcon field="type"></p-sortIcon>
                    </th>

                    <th class="nyk-categories-items" pSortableColumn="items">
                        Tételek
                        <p-sortIcon field="items"></p-sortIcon>
                    </th>

                    <th class="nyk-categories-type" pSortableColumn="isSubCategory">
                        Kategória típus<p-sortIcon field="isSubCategory"></p-sortIcon>
                    </th>

                    <th class="nyk-categories-sub-categories" pSortableColumn="subCategories">
                        Alkategóriák
                        <p-sortIcon field="subCategories"></p-sortIcon>
                    </th>

                    <th class="w-3rem"></th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-category let-i="rowIndex">
                <tr>
                    <td class="w-1">
                        <img class="hidden" [src]="category.image" (load)="imageLoaded(i)" />

                        <p-image
                            *ngIf="imageLoadedStatus[i]"
                            styleClass="shadow-2"
                            [src]="category.image"
                            [alt]="'Kategória ' + i + ' képe'"
                            [preview]="true">
                        </p-image>

                        <p-skeleton
                            *ngIf="!imageLoadedStatus[i]"
                            styleClass="skeleton"></p-skeleton>
                    </td>

                    <td class="nyk-categories-id text-primary w-9rem font-italic">
                        {{ category.id }}
                    </td>

                    <td class="text-black-alpha-90 font-medium">{{ category.name }}</td>

                    <td class="nyk-categories-item-type w-3rem">
                        <div class="flex justify-content-center">
                            <p-badge
                                *ngIf="category.type === CategoryType.Product"
                                value="Termék"
                                severity="success"
                                styleClass="shadow-2"></p-badge>

                            <p-badge
                                styleClass="shadow-2"
                                *ngIf="category.type === CategoryType.Material"
                                value="Minta"
                                severity="info"
                                styleClass="shadow-2"></p-badge>

                            <p-badge
                                *ngIf="category.type === CategoryType.Inspiration"
                                value="Inspiració"
                                styleClass="shadow-2"></p-badge>
                        </div>
                    </td>

                    <td class="nyk-categories-items font-medium w-3rem text-center">
                        <ng-container
                            *ngIf="
                                category.type === CategoryType.Product;
                                else notProductCategoryItemsPlaceholder
                            ">
                            <span *ngIf="category.isSubCategory">
                                {{ category.items.length }}
                            </span>

                            <span *ngIf="!category.isSubCategory"> - </span>
                        </ng-container>

                        <ng-template #notProductCategoryItemsPlaceholder>
                            {{ category.items.length }}
                        </ng-template>
                    </td>

                    <td class="nyk-categories-type w-3rem">
                        <p-badge
                            [value]="category.isSubCategory ? 'Alkategória' : 'Főkategória'"
                            [severity]="category.isSubCategory ? 'info' : 'warning'"
                            styleClass="shadow-2">
                        </p-badge>
                    </td>

                    <td class="nyk-categories-sub-categories font-medium w-3rem text-center">
                        <ng-container
                            *ngIf="
                                category.type === CategoryType.Product;
                                else notProductCategorySubcategoriesPlaceholder
                            ">
                            <span *ngIf="!category.isSubCategory">
                                {{ category.subCategories.length }}
                            </span>

                            <span *ngIf="category.isSubCategory"> - </span>
                        </ng-container>

                        <ng-template #notProductCategorySubcategoriesPlaceholder> - </ng-template>
                    </td>

                    <td>
                        <div class="flex flex-row">
                            <p-button
                                [raised]="true"
                                icon="pi pi-cog"
                                severity="info"
                                styleClass="mr-1"
                                [routerLink]="['/admin/categories/edit', category._id]"
                                [pTooltip]="
                                    category.isSubCategory
                                        ? 'Alkategória módosítása'
                                        : 'Főkategória módosítása'
                                "
                                tooltipPosition="left">
                            </p-button>

                            <p-button
                                [raised]="true"
                                icon="pi pi-times"
                                severity="danger"
                                [disabled]="category.items.length || category.subCategories.length"
                                [pTooltip]="
                                    category.isSubCategory
                                        ? 'Alkategória törlése'
                                        : 'Főkategória törlése'
                                "
                                tooltipPosition="left"
                                (click)="onDeleteCategory(category)">
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="8" class="text-center text-800 text-4xl">
                        Nem található kategória
                        <p-button
                            icon="pi pi-plus"
                            label="Kategória hozzáadás"
                            styleClass="p-button p-button-success block mx-auto mt-2"
                            routerLink="/admin/categories/add">
                        </p-button>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </ng-container>
</ng-container>

<ng-template #loading>
    <nyk-spinner></nyk-spinner>
</ng-template>
